#!/usr/bin/env sh
# cliv v0.1 - Execute commands using a specific directory of files and variables
# Copyright (C) 2021 Peter Willis
set -eu
[ "${DEBUG:-0}" = "1" ] && set -x

_err () { printf "%s\n" "$0: Error: $*" ; exit 1 ; }

CLIV_HTTP_PATH="${CLIV_HTTP_PATH:-https://github.com/peterwwillis/cliv/blob/main/}"
HOME="${HOME:-$(getent passwd $(id -u) | cut -d : -f 6)}"
CLIV_DIR="${CLIV_DIR:-$HOME/.cliv}"
[ -d "$CLIV_DIR" ] || mkdir -p "$CLIV_DIR"

if [ $# -lt 1 ] || [ "$1" = "-h" ] ; then
  printf "%s\n" "
Usage: $0 [OPTS]
       $0 [OPTS] VERSION [CMD [ARGS ..]]
Opts:
	-h		This screen
	-i		Clear environment variables. Must be first argument
	-l [VERSION]	List versions
	-n		Create a new $CLIV_DIR/VERSION
	-I EXT[=V]	Install version V of extension EXT into VERSION
"
  exit 1
fi

_cliv_new () {
  export CLIV_VER="$1" ; shift
  [ -d "$CLIV_DIR/$CLIV_VER" ] && _err "Version '$CLIV_DIR/$CLIV_VER' already exists"
  mkdir -p "$CLIV_DIR/$CLIV_VER/bin"
  echo "PATH=$CLIV_DIR/$CLIV_VER/bin:$PATH" > "$CLIV_DIR/$CLIV_VER/.env"
}
_cliv_list () {
  if [ $# -gt 0 ] ; then
    for d in "$@" ; do [ -d "$CLIV_DIR/$d" ] && basename $d ; done
  else
    for d in "$CLIV_DIR/"* ; do [ -d "$d" ] && basename "$d" ; done
  fi
}
_cliv_load () {
  ext="${1%%=*}" extver="${1#*=}" CLIV_VER="$2" ; shift 2
  export CLIV_VER
  [ "$extver" = "$ext" ] && extver="latest"
  echo "$0: Loading extention $ext version $extver"
  [ -d "$CLIV_DIR/.ext" ] || mkdir -p "$CLIV_DIR/.ext"
  curl -fsSL -o "$CLIV_DIR/.ext/$ext" $CLIV_HTTP_PATH/.ext/"$ext"
  chmod 755 "$CLIV_DIR/.ext/$ext"
  cd "$CLIV_DIR/$CLIV_VER"
  "$CLIV_DIR/.ext/$ext" load $extver # "$@"
}
_cliv_exec () {
  export CLIV_VER="$1" ; shift
  [ -d "$CLIV_DIR/$CLIV_VER" ] || _err "No version '$CLIV_DIR/$CLIV_VER' found"
  set -a ; . "$CLIV_DIR/$CLIV_VER/.env"
  exec env "$@"
}



[ "$1" = "-i" ] && shift 1 && exec env -i "$0" "$@"

CLIV_NEW=0 CLIV_LIST=0
while getopts "nlI:" args ; do
    case "$args" in
        n)  CLIV_NEW=1 ;;
        l)  CLIV_LIST=1 ;;
        I)  CLIV_LOAD="$OPTARG" ;;
    esac
done
shift $(($OPTIND-1))

if [ $CLIV_NEW -eq 1 ] ; then        _cliv_new "$@"
fi

if [ $CLIV_LIST -eq 1 ] ; then       _cliv_list "$@"
elif [ -n "${CLIV_LOAD:-}" ] ; then  _cliv_load "$CLIV_LOAD" "$@"
fi

if [ $# -ge 1 ] ; then             _cliv_exec "$@"
fi
